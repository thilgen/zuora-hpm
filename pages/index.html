<html>
    <head>
        <script type='text/javascript' src='https://static.zuora.com/Resources/libs/hosted/1.3.1/zuora-min.js'></script>
        <script>
            var openInvoices = []
            function buildInvoiceTableRow(invoice) {
                let invoiceTableRowProperties = [
                    'id',
                    'documentNumber',
                    'status',
                    'documentDate',
                    'amount',
                    'balance',
                ]
                let newRow = document.createElement('tr');
                for (let idx in invoiceTableRowProperties) {
                    let newCol = document.createElement('td');
                    newCol.innerHTML = invoice[invoiceTableRowProperties[idx]]
                    newRow.appendChild(newCol)
                }
                if ('Posted' == invoice.status && invoice.balance > 0) {
                    openInvoices.push(invoice)
                }
                return newRow
            }
            function buildInvoiceTableRowHeader() {
                let invoiceTableRowHeaderLabels = [
                    'Invoice ID',
                    'Invoice Number',
                    'Invoice Status',
                    'Invoice Date',
                    'Invoice Amount',
                    'Invoice Balance',
                ]
                let newRow = document.createElement('tr');
                for (let idx in invoiceTableRowHeaderLabels) {
                    let newCol = document.createElement('th');
                    newCol.innerHTML = invoiceTableRowHeaderLabels[idx]
                    newRow.appendChild(newCol)
                }
                return newRow
            }
            async function updateInvoiceList() {
                openInvoices = []
                return new Promise(function(resolve, reject) {
                    var request = new XMLHttpRequest();
                    request.open('GET', '/api/invoices', false);
                    request.setRequestHeader('content-Type', 'application/json')
                    request.onload = function() {
                        jsonResponse = JSON.parse(request.responseText)
                        var new_tbody = document.createElement('tbody');
                        new_tbody.appendChild(buildInvoiceTableRowHeader())
                        for (idx in jsonResponse.invoices) {
                            new_tbody.appendChild(buildInvoiceTableRow(jsonResponse.invoices[idx]))
                        }
                        document.getElementById('invoices_table').replaceChild(
                            new_tbody,
                            document.getElementById('invoices_table_body')
                        )
                        new_tbody.id = 'invoices_table_body'
                        addStatusMsg('Invoice List Updated')
                    }
                    request.send();
                });
            }
            async function onInvoiceButton() {
                updateInvoiceList()
            }
            async function payOpenInvoices(paymentMethodId) {
                return new Promise(function(resolve, reject) {
                    var request = new XMLHttpRequest();
                    request.open('POST', '/api/payInvoices?paymentMethodId=' + paymentMethodId, false);
                    request.setRequestHeader('content-Type', 'application/json')
                    request.onload = function() {
                        let payInvoicesResults = JSON.parse(request.responseText).payInvoicesResult
                        for (idx in payInvoicesResults) {
                            addStatusMsg('Paid Invoice ' + payInvoicesResults[idx].invoiceId + ' [' + payInvoicesResults[idx].status + ']')
                        }
                    }
                    if (openInvoices.length) {
                        request.send(JSON.stringify(openInvoices));
                    } else {
                        addStatusMsg('No Posted Invoices with non-zero balances')
                    }
                });
            }
            async function loadHPM() {
                return new Promise(function(resolve, reject) {
                    var request = new XMLHttpRequest();
                    request.open('GET', '/api/hpmParams', false);
                    request.setRequestHeader('content-Type', 'application/json')
                    request.onload = function() {
                        hpmParams = JSON.parse(request.responseText).hpmParams

                        Z.setEventHandler('onloadCallback', function() {
                            addStatusMsg('HPM Loaded')
                        });

                        hpmCallback = function(response) {
                            if (response.success == 'true') {
                                let paymentMethodId = response.refId
                                addStatusMsg('HPM SUCCEEDED - Added PaymentMethod ' + paymentMethodId)
                                if (document.getElementById('payOpenInvoicesCB').checked) {
                                    addStatusMsg('Pay Invoices CB Checked - Attempting Invoice Payment')
                                    payOpenInvoices(paymentMethodId)
                                } else {
                                    addStatusMsg('Pay Invoices CB Not Checked - Not attempting Invoice Payment')
                                }
                            } else {
                                addStatusMsg('HPM FAILED - PaymentMethod Not Added')
                            }
                        }

                        var prepopulateFields = {}
                        Z.render(hpmParams, prepopulateFields, hpmCallback);
                    }
                    request.send();
                });
            }
            async function onLoadPage() {
                addStatusMsg('Page Loaded')
                updateInvoiceList()
                loadHPM()
                document.getElementById('invoiceListButton').addEventListener('click', onInvoiceButton)
            }
            function addStatusMsg(msg) {
                document.getElementById('statusText').value += msg +'\r\n'
            }
        </script>
    </head>
    <body onload='onLoadPage();'>
        <h1>HPM Page</h1>
        <div>
            <table border='1' , id='invoices_table'>
                <tbody id='invoices_table_body'>
                    <!-- rows updated async -->
                </tbody>
            </table>
        </div>
        <div>
            <br>
            <button type='button' id='invoiceListButton'>Refresh Invoice List</button><br><br>
            <input type='checkbox' id='payOpenInvoicesCB'>
            <label for='payOpenInvoicesCB'>Pay Open Invoices</label><br><br>
        </div>
        <div id='zuora_payment'></div><br><br>
        <textarea rows='20' cols='75' id='statusText' readonly='true'></textarea>
    </body>
</html>
